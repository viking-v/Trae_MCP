# 方案B（生产方向）执行手册

## 目标与范围
### 目标
- 建立可信后端：认证、用户、邀请关系、激活审核、分润计算、审计日志统一在服务端落地
- 前端从“本地存储真源”迁移为“API 真源”，消除双系统不一致
- 建立质量门禁：自动化测试、CI、基础安全与发布回归机制
- 形成可审计的过程文档：需求、设计、变更、风险、验收记录可追溯

### 本阶段纳入范围（MVP→可运营）
- 认证：注册/登录/登出/用户信息（Token）
- 用户：角色（admin/user）、启停用、资料维护（钱包地址）
- 邀请：邀请码生成与占用、直推关系、团队树（深度限制）
- 激活：用户提交、管理员审核通过/拒绝、凭证文件存储
- 分润：按配置比例生成分润记录（随激活审核通过触发）
- 审计：关键管理员操作落库（通过/拒绝）
- 工程化：迁移脚本、种子数据、测试、CI

## 时间节点（按周拆分，可直接纳入项目排期）
以 2026-01-14 为起点，建议 6 周交付可运营版本，8 周完成强化与上线准备。

### W1（2026-01-14 ～ 01-20）：基线与统一数据源
- 交付：后端工程基线、数据模型、认证、核心 API 可跑通
- 验收：前端登录后能通过 API 获取用户信息；管理员可登录并访问后台指标

### W2（01-21 ～ 01-27）：激活闭环与分润闭环
- 交付：激活提交/审核、分润生成、审计日志、基础前端联调完成
- 验收：用户提交激活→管理员审核通过→分润记录可查询；拒绝可记录原因

### W3（01-28 ～ 02-03）：角色权限与安全基线
- 交付：角色/权限矩阵、接口鉴权覆盖、输入校验、上传校验、CORS 策略固定
- 验收：非管理员不可访问管理接口；关键接口具备最小安全基线

### W4（02-04 ～ 02-10）：质量门禁与回归体系
- 交付：核心链路自动化测试、CI 门禁、变更记录与版本发布规范
- 验收：CI 绿灯为合入前置条件；核心链路回归用例覆盖并可一键执行

### W5（02-11 ～ 02-17）：可观测与运营能力
- 交付：关键事件日志、基础报表指标、异常与告警策略（可先落文档与本地实现）
- 验收：可对激活/审核/分润进行追溯与对账；异常场景有应对流程

### W6（02-18 ～ 02-24）：上线准备与演练
- 交付：部署文档、数据备份与回滚策略、灰度/回滚演练记录
- 验收：完成一次从空环境到可用环境的演练，含回滚验证

### W7-W8（可选强化）
- 性能压测、更多权限角色（auditor/viewer）、对账导出、更多审计维度

## 资源与职责（RACI）
### 角色配置（建议最小配置）
- 产品/业务（PO）：1
- 后端工程：1-2
- 前端工程：1
- 测试/质量：1（可兼职）
- 安全/合规：1（兼职评审）
- 运维/平台：1（兼职）

### RACI（关键事项）
- 需求范围与验收标准：R=PO，A=PO，C=后端/前端/测试，I=运维/安全
- 数据模型与接口契约：R=后端，A=后端负责人，C=前端/测试/安全，I=PO/运维
- 前端迁移与页面联调：R=前端，A=前端负责人，C=后端/测试，I=PO
- 测试与CI门禁：R=测试，A=测试负责人，C=后端/前端，I=PO/运维
- 部署与回滚：R=运维，A=运维负责人，C=后端/安全，I=PO

## 详细执行步骤（工程落地清单）
### 1. 架构与数据
- 设计领域模型：用户/邀请码/推荐关系/激活/分润/审计
- 明确状态机：activation_status、activation.status 的流转与约束
- 明确幂等策略：审核接口需防重复执行（通过/拒绝仅允许 pending→终态）

### 2. API 契约
- 统一命名：前端使用 camelCase，后端存储 snake_case，通过 Presenter/Resource 映射
- 统一鉴权：Bearer Token；所有管理端 API 必须加 role 校验
- 统一错误：401/403/422/409 的语义固定，前端统一处理

### 3. 前端改造
- 所有核心数据读取从 API 获取，禁止再以 localStorage 作为业务真源
- 激活上传使用 FormData，后端存储到 public disk，并提供 URL
- 邀请链接携带 invite 参数，注册时带入 inviteCode 提交

### 4. 质量与发布
- 必备测试：注册登录、激活审核生成分润、权限隔离
- CI：PR/Push 自动跑测试；不通过禁止合入
- 版本与变更：每次迭代输出变更说明、风险、回滚点

## KPI（衡量“方案效果”的量化指标）
### 交付与质量（工程 KPI）
- 测试覆盖：核心链路用例覆盖率 ≥ 80%（按用例覆盖而非行覆盖）
- CI 稳定性：主干构建成功率 ≥ 95%
- 缺陷密度：P0/P1 缺陷在发布前清零；P2 缺陷可控并有修复计划
- 变更失败率：发布后回滚/热修占比 ≤ 10%

### 安全与合规（安全 KPI）
- 鉴权覆盖：管理端接口鉴权覆盖率 100%
- 敏感信息：仓库中不得出现密钥/口令；安全扫描 0 高危
- 审计完整性：激活审核与分润生成事件可追溯率 100%

### 运营与体验（业务 KPI）
- 激活处理时长：从提交到审核完成的 P50/P95
- 对账一致性：分润记录与激活记录关联一致率 100%
- 用户留存：按业务需要定义（可后续纳入）

## 汇报机制（进展监控与决策节奏）
### 固定会议
- 每日站会（15min）：昨日完成/今日计划/阻塞项
- 每周例会（45-60min）：里程碑进度、风险清单、资源调整
- 关键评审（按需）：接口契约评审、上线评审、复盘会议

### 固定产出物
- 周报：进度（完成/偏差）、风险（新增/关闭）、下周计划、需要支持点
- 版本说明：变更摘要、影响面、验证结果、回滚方案
- 风险台账：风险描述、等级、责任人、缓解措施、截止日期

## 跨部门协同与问题处理机制
- 协同流程：需求变更必须同步到需求文档与接口契约，并通过评审
- 阻塞升级：阻塞超过 24h 自动升级到周会/负责人群；超过 48h 触发资源调整
- 线上故障：按“分级响应”处理（P0/P1/P2），并在 24h 内补齐复盘与行动项

## 文档与记录要求（可审计）
- 必须沉淀：需求说明、接口契约、数据库变更、关键设计决策、测试报告、上线与回滚演练记录
- 文档规范：每份文档有负责人、版本号、最后更新时间、变更摘要

